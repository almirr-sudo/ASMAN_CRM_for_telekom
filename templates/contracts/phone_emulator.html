{% extends "base.html" %}
{% block title %}Эмулятор телефона{% endblock %}

{% block extra_head %}
<style>
.iphone-shell {
    width: 360px;
    border-radius: 45px;
    padding: 22px 18px 28px;
    background: linear-gradient(145deg, #15161d, #1f2130);
    box-shadow: 0 20px 50px rgba(15, 23, 42, 0.4);
    border: 6px solid #05060a;
}
.iphone-notch {
    width: 180px;
    height: 26px;
    background: #05060a;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    margin: 0 auto 16px;
    position: relative;
}
.iphone-notch::after {
    content: '';
    position: absolute;
    top: 8px;
    right: 18px;
    width: 38px;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.25);
}
.iphone-screen {
    background: radial-gradient(circle at top, #2f334e, #151728);
    border-radius: 32px;
    padding: 18px;
    min-height: 600px;
    color: white;
    display: flex;
    flex-direction: column;
    gap: 14px;
}
.status-bar {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    opacity: 0.8;
}
.glass-tile {
    background: rgba(15, 23, 42, 0.45);
    border-radius: 22px;
    padding: 14px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
    backdrop-filter: blur(10px);
}
.phone-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 18px;
    padding: 10px 16px;
    font-weight: 600;
    width: 100%;
}
.phone-button--primary {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}
.phone-button--secondary {
    background: rgba(255,255,255,0.1);
    color: white;
}
.phone-input {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 16px;
    padding: 10px 14px;
    color: white;
    font-size: 14px;
}
.phone-input::placeholder {
    color: rgba(255,255,255,0.5);
}
.slider {
    width: 100%;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const slider = document.querySelector('[data-slider]');
    const output = document.querySelector('[data-slider-output]');
    if (slider && output) {
        const sync = () => output.textContent = slider.value;
        slider.addEventListener('input', sync);
        sync();
    }
});
</script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <div class="glass-panel p-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between animate-card">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Эмулятор телефона абонента</h1>
            <p class="text-gray-500 mt-1">Моделируйте реальные действия клиента: звонки, интернет и обращения в поддержку в интерфейсе, похожем на iPhone.</p>
        </div>
        <form method="get" class="flex items-center gap-3 form-shell">
            <label class="text-sm font-medium text-gray-600">Выбрать договор</label>
            <select name="contract" class="rounded-2xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" onchange="this.form.submit()">
                {% for contract in contracts %}
                <option value="{{ contract.id }}" {% if selected_contract and contract.id == selected_contract.id %}selected{% endif %}>
                    {{ contract.customer.get_full_name }} — {{ contract.sim_card.msisdn|default:"без номера" }}
                </option>
                {% empty %}
                <option>Нет активных договоров</option>
                {% endfor %}
            </select>
        </form>
    </div>

    {% if selected_contract %}
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
        <div class="flex justify-center">
            <div class="iphone-shell">
                <div class="iphone-notch"></div>
                <div class="iphone-screen">
                    <div class="status-bar">
                        {% now "H:i" as current_time %}
                        <span>{{ current_time }}</span>
                        <span>{{ selected_contract.customer.get_full_name|truncatechars:18 }}</span>
                        <span>LTE • 78%</span>
                    </div>

                    <div class="glass-tile space-y-3">
                        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-gray-400">
                            <span>Вызов</span>
                            <span>{{ selected_contract.sim_card.msisdn|default:"не назначен" }}</span>
                        </div>
                        <form method="post" class="space-y-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="call">
                            <input type="hidden" name="contract_id" value="{{ selected_contract.id }}">
                            <input type="text" name="destination" class="phone-input" placeholder="+996 700 000 000">
                            <div class="flex items-center gap-3">
                                <input type="number" name="duration" min="1" max="60" value="3" class="phone-input" placeholder="Длительность (мин)">
                                <div class="text-xs text-gray-300">
                                    <p>{{ usage_rates.minute }} с/мин</p>
                                    <p class="opacity-70">Тариф</p>
                                </div>
                            </div>
                            <button type="submit" class="phone-button phone-button--primary">Позвонить</button>
                        </form>
                    </div>

                    <div class="glass-tile space-y-3">
                        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-gray-400">
                            <span>Интернет</span>
                            <span id="data-indicator"><span data-slider-output></span> МБ</span>
                        </div>
                        <form method="post" class="space-y-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="data">
                            <input type="hidden" name="contract_id" value="{{ selected_contract.id }}">
                            <input type="range" name="data_mb" min="10" max="1024" value="150" step="10" class="slider" data-slider>
                            <div class="flex items-center justify-between text-xs text-gray-300">
                                <span>Стоимость 1 ГБ</span>
                                <span>{{ usage_rates.data }} с</span>
                            </div>
                            <button type="submit" class="phone-button phone-button--secondary">Использовать трафик</button>
                        </form>
                    </div>

                    <div class="glass-tile space-y-3">
                        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-gray-400">
                            <span>SMS</span>
                            <span>{{ usage_rates.sms }} с/SMS</span>
                        </div>
                        <form method="post" class="space-y-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="sms">
                            <input type="hidden" name="contract_id" value="{{ selected_contract.id }}">
                            <input type="text" name="sms_destination" class="phone-input" placeholder="Номер получателя">
                            <textarea name="sms_body" rows="2" class="phone-input" placeholder="Текст сообщения"></textarea>
                            <div class="flex items-center gap-3">
                                <input type="number" name="sms_count" min="1" max="10" value="1" class="phone-input" placeholder="Количество">
                                <p class="text-xs text-gray-400">Списывается сразу</p>
                            </div>
                            <button type="submit" class="phone-button phone-button--secondary">Отправить SMS</button>
                        </form>
                    </div>

                    <div class="glass-tile space-y-3">
                        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-gray-400">
                            <span>Поддержка</span>
                            <span>тикет</span>
                        </div>
                        <form method="post" class="space-y-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="support">
                            <input type="hidden" name="contract_id" value="{{ selected_contract.id }}">
                            <input type="text" name="subject" class="phone-input" placeholder="Тема обращения">
                            <textarea name="message" rows="3" class="phone-input" placeholder="Опишите проблему"></textarea>
                            <div class="flex items-center gap-3">
                                <select name="category" class="phone-input">
                                    <option value="technical">Техническая проблема</option>
                                    <option value="billing">Оплата</option>
                                    <option value="sim">SIM-карта</option>
                                    <option value="tariff">Тариф</option>
                                    <option value="complaint">Жалоба</option>
                                    <option value="other">Другое</option>
                                </select>
                                <select name="priority" class="phone-input">
                                    <option value="medium">Стандарт</option>
                                    <option value="low">Низкий</option>
                                    <option value="high">Высокий</option>
                                    <option value="critical">Критичный</option>
                                </select>
                            </div>
                            <button type="submit" class="phone-button phone-button--primary">Отправить тикет</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass-panel p-6 space-y-4 animate-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs uppercase text-gray-400">Абонент</p>
                        <p class="text-xl font-semibold text-gray-900">{{ selected_contract.customer.get_full_name }}</p>
                        <p class="text-sm text-gray-500">{{ selected_contract.tariff.name }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs uppercase text-gray-400">Баланс</p>
                        <p class="text-2xl font-bold {% if selected_contract.balance < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            {{ selected_contract.balance }} с
                        </p>
                        <p class="text-xs text-gray-500">Статус: {{ selected_contract.get_status_display }}</p>
                    </div>
                </div>
                <dl class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                    <div>
                        <dt class="text-gray-400 uppercase text-xs">Номер</dt>
                        <dd>{{ selected_contract.sim_card.msisdn|default:"—" }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-400 uppercase text-xs">Дата подключения</dt>
                        <dd>{{ selected_contract.created_at|date:"d.m.Y" }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-400 uppercase text-xs">Мин. сверхлимит</dt>
                        <dd>{{ usage_rates.minute }} с</dd>
                    </div>
                    <div>
                        <dt class="text-gray-400 uppercase text-xs">1 ГБ сверхлимит</dt>
                        <dd>{{ usage_rates.data }} с</dd>
                    </div>
                </dl>
            </div>

            <div class="glass-panel p-6 space-y-4 animate-card animate-delay-1">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Журнал действий</h3>
                    <span class="text-sm text-gray-500">обновляется в реальном времени</span>
                </div>
                <div class="space-y-3">
                    {% for payment in recent_payments %}
                    <div class="flex items-center justify-between text-sm">
                        <div>
                            <p class="font-semibold text-gray-900">{{ payment.payment_date|date:"d.m H:i" }}</p>
                            <p class="text-gray-500">{{ payment.description|truncatechars:60 }}</p>
                        </div>
                        {% if payment.transaction_type == 'payment' %}
                        <p class="font-bold text-green-600">+{{ payment.amount }} с</p>
                        {% else %}
                        <p class="font-bold text-red-600">-{{ payment.amount }} с</p>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-500">Пока нет списаний от эмулятора.</p>
                    {% endfor %}
                </div>
                <div class="border-t border-gray-100 pt-4">
                    <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">Последние тикеты</h4>
                    <div class="mt-2 space-y-3">
                        {% for ticket in recent_tickets %}
                        <div class="flex items-center justify-between text-sm">
                            <div>
                                <p class="font-semibold text-gray-900">#{{ ticket.id }} · {{ ticket.get_category_display }}</p>
                                <p class="text-gray-500">{{ ticket.subject|truncatechars:60 }}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    {% if ticket.resolution %}
                                        Решение: {{ ticket.resolution|truncatechars:80 }}
                                    {% else %}
                                        Решение пока не добавлено
                                    {% endif %}
                                </p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full {% if ticket.priority == 'high' %}bg-red-100 text-red-700{% elif ticket.priority == 'low' %}bg-gray-100 text-gray-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                {{ ticket.get_priority_display }}
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500">Тикетов пока нет.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="glass-panel p-8 text-center text-gray-500">
        Нет активных договоров для эмуляции. Создайте хотя бы одного абонента с действующим договором.
    </div>
    {% endif %}
</div>
{% endblock %}

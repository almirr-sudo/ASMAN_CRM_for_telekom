{% extends 'base.html' %}
{% block title %}Договор {{ contract.number }}{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold">Договор {{ contract.number }}</h1>
        <div class="flex gap-3">
            <a href="{% url 'contract_print' contract.id %}" target="_blank" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow ring-1 ring-gray-300 hover:bg-gray-50">
                Печать
            </a>
            {% if contract.status != 'terminated' %}
            <a href="#terminate-card" class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-500">
                Расторгнуть
            </a>
            {% endif %}
        </div>
    </div>
    <div class="grid grid-cols-3 gap-6">
        <div class="bg-white shadow rounded p-6"><h3 class="font-semibold mb-4">Информация</h3>
            <dl class="space-y-2 text-sm">
                <div><dt class="text-gray-500">Абонент</dt><dd><a href="{% url 'customer_detail' contract.customer.id %}" class="text-primary-600">{{ contract.customer.get_full_name }}</a></dd></div>
                <div><dt class="text-gray-500">Тариф</dt><dd>{{ contract.tariff.name }}</dd></div>
                <div><dt class="text-gray-500">SIM</dt><dd>{{ contract.sim_card.msisdn|default:"-" }}</dd></div>
                <div><dt class="text-gray-500">Баланс</dt><dd class="{% if contract.balance < 0 %}text-red-600{% else %}text-green-600{% endif %} font-bold">{{ contract.balance }} с</dd></div>
                <div><dt class="text-gray-500">Статус</dt><dd>
                    {% if contract.status == 'active' %}
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Активный</span>
                    {% elif contract.status == 'suspended' %}
                    <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Приостановлен</span>
                    {% elif contract.status == 'terminated' %}
                    <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded">Расторгнут</span>
                    {% elif contract.status == 'draft' %}
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Черновик</span>
                    {% else %}
                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ contract.get_status_display }}</span>
                    {% endif %}
                </dd></div>
                {% if contract.termination_date %}
                <div><dt class="text-gray-500">Дата расторжения</dt><dd>{{ contract.termination_date|date:"d.m.Y" }}</dd></div>
                {% endif %}
            </dl>
        </div>
        <div class="col-span-2 bg-white shadow rounded p-6"><h3 class="font-semibold mb-4">Платежи</h3>
            <div class="space-y-2">
                {% for payment in payments %}
                <div class="flex justify-between border-b pb-2"><div><p class="font-medium">{{ payment.get_transaction_type_display }}</p><p class="text-xs text-gray-500">{{ payment.payment_date|date:"d.m.Y H:i" }}</p></div><span class="font-bold {% if payment.transaction_type == 'payment' %}text-green-600{% else %}text-red-600{% endif %}">{% if payment.transaction_type == 'payment' %}+{% else %}-{% endif %}{{ payment.amount }} с</span></div>
                {% empty %}
                <p class="text-gray-500">Нет платежей</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% if contract.status != 'terminated' %}
    <div id="terminate-card" class="mt-8 bg-white shadow rounded p-6 border border-red-100">
        <h3 class="text-lg font-semibold text-red-700 mb-2">Расторгнуть договор</h3>
        <p class="text-sm text-gray-600 mb-4">SIM-карта будет автоматически освобождена и вернется в список свободных. Укажите причину для истории.</p>
        <form method="post" action="{% url 'contract_terminate' contract.id %}" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700">Причина расторжения</label>
                <textarea name="reason" rows="3" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500" placeholder="Например: инициатива клиента, задолженность, переход к другому оператору"></textarea>
            </div>
            <button type="submit" class="inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-500">
                Подтвердить расторжение
            </button>
        </form>
    </div>
    {% elif contract.notes %}
    <div class="mt-8 bg-white shadow rounded p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Примечания</h3>
        <p class="text-sm text-gray-600 whitespace-pre-line">{{ contract.notes }}</p>
    </div>
    {% endif %}
</div>
{% endblock %}
